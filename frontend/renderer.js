// Configura√ß√µes da aplica√ß√£o
const CONFIG = {
    API_BASE_URL: 'http://127.0.0.1:5000',
    CHECK_INTERVAL: 5000, // 5 segundos
    TIMEOUT: 30000 // 30 segundos
};

// Elementos DOM
const elements = {
    inputPath: document.getElementById('inputPath'),
    outputFolder: document.getElementById('outputFolder'),
    selectFileBtn: document.getElementById('selectFileBtn'),
    selectFolderBtn: document.getElementById('selectFolderBtn'),
    selectOutputFolderBtn: document.getElementById('selectOutputFolderBtn'),
    processBtn: document.getElementById('processBtn'),
    clearBtn: document.getElementById('clearBtn'),
    openFolderBtn: document.getElementById('openFolderBtn'),
    statusMessage: document.getElementById('statusMessage'),
    progressBar: document.getElementById('progressBar'),
    resultCard: document.getElementById('resultCard'),
    resultContent: document.getElementById('resultContent'),
    // Bot√µes da barra de t√≠tulo
    minimizeBtn: document.getElementById('minimizeBtn'),
    maximizeBtn: document.getElementById('maximizeBtn'),
    closeBtn: document.getElementById('closeBtn'),
    // Bot√£o de tema
    themeToggleBtn: document.getElementById('themeToggleBtn')
};

// Estado da aplica√ß√£o
let appState = {
    selectedPath: null,
    selectedFolder: null,
    isProcessing: false,
    serverOnline: false,
    currentTheme: 'light', // 'light' ou 'dark'
    lastOutputFolder: null // Armazenar a √∫ltima pasta de sa√≠da usada
};

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    setupEventListeners();
    startServerHealthCheck();
});

function initializeApp() {
    console.log('üöÄ Inicializando aplica√ß√£o...');
    loadTheme();
    updateUI();
    checkServerHealth();
}

function setupEventListeners() {
    console.log('üîß Configurando event listeners...');
    console.log('üîç Elementos encontrados:', {
        minimizeBtn: elements.minimizeBtn ? 'encontrado' : 'n√£o encontrado',
        maximizeBtn: elements.maximizeBtn ? 'encontrado' : 'n√£o encontrado',
        closeBtn: elements.closeBtn ? 'encontrado' : 'n√£o encontrado',
        themeToggleBtn: elements.themeToggleBtn ? 'encontrado' : 'n√£o encontrado'
    });
    
    // Bot√µes de sele√ß√£o
    elements.selectFileBtn.addEventListener('click', selectFile);
    elements.selectFolderBtn.addEventListener('click', selectFolder);
    elements.selectOutputFolderBtn.addEventListener('click', selectOutputFolder);
    
    // Bot√£o de processamento
    elements.processBtn.addEventListener('click', processFile);
    
    // Bot√£o de limpar
    elements.clearBtn.addEventListener('click', clearForm);
    
    // Bot√£o de abrir pasta
    elements.openFolderBtn.addEventListener('click', openOutputFolder);
    
    // Bot√µes da barra de t√≠tulo
    if (elements.minimizeBtn) {
        elements.minimizeBtn.addEventListener('click', () => {
            console.log('ü™ü Minimizando janela...');
            window.electronAPI.minimizeWindow();
        });
    }
    
    if (elements.maximizeBtn) {
        elements.maximizeBtn.addEventListener('click', () => {
            console.log('ü™ü Maximizando janela...');
            window.electronAPI.maximizeWindow();
        });
    }
    
    if (elements.closeBtn) {
        elements.closeBtn.addEventListener('click', () => {
            console.log('ü™ü Fechando janela...');
            window.electronAPI.closeWindow();
        });
    }
    
    // Bot√£o de tema
    if (elements.themeToggleBtn) {
        elements.themeToggleBtn.addEventListener('click', toggleTheme);
    }
    
    // Sistema de abas
    setupTabs();
    
    // Link do GitHub
    setupGitHubLink();
    
    // Mudan√ßas nos inputs
    elements.inputPath.addEventListener('change', updateUI);
    elements.outputFolder.addEventListener('change', updateUI);
}

// Sele√ß√£o de arquivos e pastas
async function selectFile() {
    try {
        console.log('üìÇ Abrindo seletor de arquivo...');
        
        // Usar API do Electron para sele√ß√£o de arquivo
        const result = await window.electronAPI.selectFile();
        
        if (result && result.filePaths && result.filePaths.length > 0) {
            const filePath = result.filePaths[0];
            elements.inputPath.value = filePath;
            appState.selectedPath = filePath;
            updateUI();
            
            console.log('‚úÖ Arquivo selecionado:', filePath);
        }
    } catch (error) {
        console.error('‚ùå Erro ao selecionar arquivo:', error);
        showStatus('Erro ao selecionar arquivo', 'error');
    }
}

async function selectFolder() {
    try {
        console.log('üìÅ Abrindo seletor de pasta de entrada...');
        console.log('üîç Verificando API do Electron:', window.electronAPI);
        
        if (!window.electronAPI) {
            throw new Error('API do Electron n√£o est√° dispon√≠vel');
        }
        
        if (!window.electronAPI.selectFolder) {
            throw new Error('Fun√ß√£o selectFolder n√£o est√° dispon√≠vel');
        }
        
        // Usar API do Electron para sele√ß√£o de pasta
        const result = await window.electronAPI.selectFolder();
        console.log('üìÅ Resultado da sele√ß√£o:', result);
        
        if (result && result.filePaths && result.filePaths.length > 0) {
            const folderPath = result.filePaths[0];
            elements.inputPath.value = folderPath;
            appState.selectedPath = folderPath;
            updateUI();
            
            console.log('‚úÖ Pasta de entrada selecionada:', folderPath);
        } else {
            console.log('‚ÑπÔ∏è Sele√ß√£o cancelada pelo usu√°rio');
        }
    } catch (error) {
        console.error('‚ùå Erro ao selecionar pasta:', error);
        showStatus('Erro ao selecionar pasta: ' + error.message, 'error');
    }
}

async function selectOutputFolder() {
    try {
        console.log('üìÅ Abrindo seletor de pasta de sa√≠da...');
        console.log('üîç Verificando API do Electron:', window.electronAPI);
        
        if (!window.electronAPI) {
            throw new Error('API do Electron n√£o est√° dispon√≠vel');
        }
        
        if (!window.electronAPI.selectOutputFolder) {
            throw new Error('Fun√ß√£o selectOutputFolder n√£o est√° dispon√≠vel');
        }
        
        // Usar API do Electron para sele√ß√£o de pasta de sa√≠da
        const result = await window.electronAPI.selectOutputFolder();
        console.log('üìÅ Resultado da sele√ß√£o:', result);
        
        if (result && result.filePaths && result.filePaths.length > 0) {
            const folderPath = result.filePaths[0];
            elements.outputFolder.value = folderPath;
            appState.selectedFolder = folderPath;
            updateUI();
            
            console.log('‚úÖ Pasta de sa√≠da selecionada:', folderPath);
        } else {
            console.log('‚ÑπÔ∏è Sele√ß√£o cancelada pelo usu√°rio');
        }
    } catch (error) {
        console.error('‚ùå Erro ao selecionar pasta de sa√≠da:', error);
        showStatus('Erro ao selecionar pasta de sa√≠da: ' + error.message, 'error');
    }
}

// Processamento do arquivo
async function processFile() {
    if (!appState.selectedPath || !appState.selectedFolder) {
        showStatus('Selecione arquivo(s)/pasta e uma pasta de sa√≠da', 'error');
        return;
    }
    
    if (appState.isProcessing) {
        return;
    }
    
    try {
        appState.isProcessing = true;
        updateUI();
        
        showStatus('Processando arquivo(s) de balancete...', 'processing');
        showProgress(true);
        
        console.log('‚ö° Iniciando processamento...');
        console.log('üìÅ Caminho de entrada:', appState.selectedPath);
        console.log('üìÇ Pasta de sa√≠da:', appState.selectedFolder);
        
        const response = await fetch(`${CONFIG.API_BASE_URL}/process-file`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                inputPath: appState.selectedPath,
                outputFolder: appState.selectedFolder,
                operation: 'balancete'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Armazenar a pasta de sa√≠da para o bot√£o "Abrir Pasta"
            appState.lastOutputFolder = appState.selectedFolder;
            showStatus(data.message, 'success');
            showResult(data);
            console.log('‚úÖ Processamento conclu√≠do:', data);
        } else {
            showStatus(data.message || 'Erro no processamento', 'error');
            console.error('‚ùå Erro no processamento:', data);
        }
        
    } catch (error) {
        console.error('‚ùå Erro na requisi√ß√£o:', error);
        showStatus('Erro de comunica√ß√£o com o servidor', 'error');
    } finally {
        appState.isProcessing = false;
        showProgress(false);
        updateUI();
    }
}

// Verifica√ß√£o de sa√∫de do servidor
async function checkServerHealth() {
    try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/health`, {
            method: 'GET',
            timeout: 5000
        });
        
        if (response.ok) {
            const data = await response.json();
            appState.serverOnline = true;
            console.log('‚úÖ Servidor online:', data);
        } else {
            throw new Error('Servidor n√£o respondeu');
        }
    } catch (error) {
        appState.serverOnline = false;
        console.warn('‚ö†Ô∏è Servidor offline:', error.message);
    }
}

function startServerHealthCheck() {
    // Verificar sa√∫de do servidor a cada 5 segundos
    setInterval(checkServerHealth, CONFIG.CHECK_INTERVAL);
}

// Atualiza√ß√£o da interface
function updateUI() {
    const canProcess = appState.selectedPath && 
                      appState.selectedFolder && 
                      !appState.isProcessing && 
                      appState.serverOnline;
    
    elements.processBtn.disabled = !canProcess;
    
    if (appState.isProcessing) {
        elements.processBtn.innerHTML = '<span class="loading"></span> Processando...';
    } else {
        elements.processBtn.innerHTML = '‚ö° Processar Balancete';
    }
}


// Exibi√ß√£o de status e resultados
function showStatus(message, type = 'info') {
    elements.statusMessage.textContent = message;
    elements.statusMessage.className = `status-message ${type}`;
}

function showProgress(show) {
    elements.progressBar.style.display = show ? 'block' : 'none';
    
    if (show) {
        // Simular progresso
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
            }
            elements.progressBar.querySelector('.progress-fill').style.width = progress + '%';
        }, 200);
    }
}

function showResult(data) {
    elements.resultCard.style.display = 'block';
    
    // Mostrar bot√£o "Abrir Pasta" se houver pasta de sa√≠da
    if (appState.lastOutputFolder) {
        elements.openFolderBtn.style.display = 'inline-flex';
    }
    
    // Criar HTML formatado para os resultados
    let resultHTML = '';
    
    if (data.result && data.result.processed_files) {
        resultHTML += '<div class="result-summary">';
        resultHTML += `<h3>üìä Resumo do Processamento</h3>`;
        resultHTML += `<p><strong>Total processado:</strong> ${data.result.processed_count} arquivo(s)</p>`;
        resultHTML += `<p><strong>Data/Hora:</strong> ${formatDate(data.timestamp)}</p>`;
        if (appState.lastOutputFolder) {
            resultHTML += `<p><strong>Pasta de sa√≠da:</strong> ${appState.lastOutputFolder}</p>`;
        }
        resultHTML += '</div>';
        
        resultHTML += '<div class="result-logs">';
        resultHTML += '<h3>üìã Log de Arquivos</h3>';
        
        // Processar arquivos com sucesso
        data.result.processed_files.forEach(file => {
            const fileName = file.inputFile.split('\\').pop().split('/').pop(); // Pegar apenas o nome do arquivo
            resultHTML += `<div class="log-entry success">`;
            resultHTML += `<span class="log-icon">‚úÖ</span>`;
            resultHTML += `<span class="log-file">${fileName}</span>`;
            resultHTML += `<span class="log-status">SUCESSO</span>`;
            resultHTML += `</div>`;
        });
        
        // Processar erros
        if (data.result.errors && data.result.errors.length > 0) {
            data.result.errors.forEach(error => {
                resultHTML += `<div class="log-entry error">`;
                resultHTML += `<span class="log-icon">‚ùå</span>`;
                resultHTML += `<span class="log-file">${extractFileNameFromError(error)}</span>`;
                resultHTML += `<span class="log-status">FALHA</span>`;
                resultHTML += `<div class="log-error-detail">Erro: ${error}</div>`;
                resultHTML += `</div>`;
            });
        }
        
        resultHTML += '</div>';
    } else {
        // Fallback para dados n√£o estruturados
        resultHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    }
    
    elements.resultContent.innerHTML = resultHTML;
}

function extractFileNameFromError(errorMessage) {
    // Tentar extrair o nome do arquivo da mensagem de erro
    const match = errorMessage.match(/processar\s+([^:]+)/i);
    if (match) {
        return match[1];
    }
    return 'Arquivo desconhecido';
}

function clearForm() {
    elements.inputPath.value = '';
    elements.outputFolder.value = '';
    
    appState.selectedPath = null;
    appState.selectedFolder = null;
    appState.lastOutputFolder = null;
    
    elements.resultCard.style.display = 'none';
    elements.openFolderBtn.style.display = 'none';
    showStatus('Selecione arquivo(s)/pasta e uma pasta de sa√≠da para come√ßar');
    
    updateUI();
    
    console.log('üóëÔ∏è Formul√°rio limpo');
}

async function openOutputFolder() {
    try {
        console.log('üìÅ Abrindo pasta de sa√≠da:', appState.lastOutputFolder);
        
        if (!appState.lastOutputFolder) {
            showStatus('Nenhuma pasta de sa√≠da dispon√≠vel', 'error');
            return;
        }
        
        // Usar API do Electron para abrir pasta
        if (window.electronAPI && window.electronAPI.openFolder) {
            await window.electronAPI.openFolder(appState.lastOutputFolder);
            console.log('‚úÖ Pasta aberta com sucesso');
        } else {
            // Fallback: tentar abrir com shell do sistema
            const { shell } = require('electron');
            shell.openPath(appState.lastOutputFolder);
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao abrir pasta:', error);
        showStatus('Erro ao abrir pasta: ' + error.message, 'error');
    }
}

// Utilit√°rios
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleString('pt-BR');
}

// Tratamento de erros globais
window.addEventListener('error', function(event) {
    console.error('‚ùå Erro global:', event.error);
    showStatus('Ocorreu um erro inesperado', 'error');
});

window.addEventListener('unhandledrejection', function(event) {
    console.error('‚ùå Promise rejeitada:', event.reason);
    showStatus('Erro de comunica√ß√£o', 'error');
});

// Fun√ß√µes de controle de tema
function loadTheme() {
    const savedTheme = localStorage.getItem('app-theme') || 'light';
    appState.currentTheme = savedTheme;
    applyTheme(savedTheme);
    updateThemeIcon();
}

function toggleTheme() {
    appState.currentTheme = appState.currentTheme === 'light' ? 'dark' : 'light';
    applyTheme(appState.currentTheme);
    updateThemeIcon();
    localStorage.setItem('app-theme', appState.currentTheme);
    console.log(`üé® Tema alterado para: ${appState.currentTheme}`);
}

function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
}

function updateThemeIcon() {
    const themeIcon = elements.themeToggleBtn.querySelector('.theme-icon');
    if (themeIcon) {
        themeIcon.textContent = appState.currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    }
}

// Sistema de Abas
function setupTabs() {
    const tabButtons = document.querySelectorAll('.tab-button:not(.add-tab-btn)');
    const tabContents = document.querySelectorAll('.tab-content');
    const addTabBtn = document.getElementById('addTabBtn');
    
    console.log('üìë Elementos encontrados:', {
        tabButtons: tabButtons.length,
        tabContents: tabContents.length,
        addTabBtn: addTabBtn ? 'encontrado' : 'n√£o encontrado'
    });
    
    // Event listeners para as abas
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.getAttribute('data-tab');
            console.log('üìë Clicando na aba:', tabId);
            switchTab(tabId);
        });
    });
    
    // Event listener para adicionar nova aba
    if (addTabBtn) {
        addTabBtn.addEventListener('click', addNewTab);
    }
    
    console.log('üìë Sistema de abas configurado');
}

function switchTab(tabId) {
    // Remover classe active de todas as abas
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // Adicionar classe active na aba selecionada
    const activeButton = document.querySelector(`[data-tab="${tabId}"]`);
    const activeContent = document.getElementById(`tab-${tabId}`);
    
    if (activeButton && activeContent) {
        activeButton.classList.add('active');
        activeContent.classList.add('active');
        console.log(`üìë Aba ativada: ${tabId}`);
    }
}

function addNewTab() {
    const tabName = prompt('Nome da nova aba:');
    if (tabName) {
        const tabId = `tab-${Date.now()}`;
        const tabButton = document.createElement('button');
        tabButton.className = 'tab-button';
        tabButton.setAttribute('data-tab', tabId);
        tabButton.textContent = `üìÑ ${tabName}`;
        
        const tabContent = document.createElement('div');
        tabContent.className = 'tab-content';
        tabContent.id = `tab-${tabId}`;
        tabContent.innerHTML = `
            <div class="main-content">
                <div class="card">
                    <h2>üìÑ ${tabName}</h2>
                    <p>Nova aba personalizada</p>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary">üöÄ Executar</button>
                    </div>
                </div>
            </div>
        `;
        
        // Adicionar antes do bot√£o de adicionar
        const addTabBtn = document.getElementById('addTabBtn');
        addTabBtn.parentNode.insertBefore(tabButton, addTabBtn);
        
        // Adicionar conte√∫do
        document.querySelector('.tabs-content').appendChild(tabContent);
        
        // Event listener para a nova aba
        tabButton.addEventListener('click', () => switchTab(tabId));
        
        // Ativar a nova aba
        switchTab(tabId);
        
        console.log(`üìë Nova aba criada: ${tabName}`);
    }
}

// Configurar link do GitHub
function setupGitHubLink() {
    const githubLink = document.getElementById('githubLink');
    if (githubLink) {
        githubLink.addEventListener('click', (event) => {
            event.preventDefault();
            console.log('üîó Abrindo GitHub no navegador padr√£o...');
            
            // Usar API do Electron para abrir no navegador padr√£o
            if (window.electronAPI && window.electronAPI.openExternal) {
                window.electronAPI.openExternal('https://github.com/AlexandreSilvestrin');
            } else {
                // Fallback: tentar usar shell do sistema
                const { shell } = require('electron');
                shell.openExternal('https://github.com/AlexandreSilvestrin');
            }
        });
        
        console.log('üîó Link do GitHub configurado');
    }
}

// ==================== SISTEMA DE ATUALIZA√á√ïES ====================

// Elementos DOM para atualiza√ß√µes
const updateElements = {
    currentVersion: document.getElementById('currentVersion'),
    updateStatus: document.getElementById('updateStatus'),
    checkUpdatesBtn: document.getElementById('checkUpdatesBtn'),
    downloadUpdateBtn: document.getElementById('downloadUpdateBtn'),
    installUpdateBtn: document.getElementById('installUpdateBtn'),
    updateProgress: document.getElementById('updateProgress'),
    updateProgressFill: document.getElementById('updateProgressFill'),
    updateProgressText: document.getElementById('updateProgressText'),
    updateMessage: document.getElementById('updateMessage')
};

// Elementos DOM para notifica√ß√£o de vers√£o
const versionElements = {
    notification: document.getElementById('versionNotification'),
    icon: document.getElementById('versionIcon'),
    text: document.getElementById('versionText'),
    actionBtn: document.getElementById('versionActionBtn')
};

// Estado das atualiza√ß√µes
let updateState = {
    isChecking: false,
    isDownloading: false,
    updateAvailable: false,
    updateDownloaded: false,
    currentVersion: null,
    latestVersion: null
};

// Estado da notifica√ß√£o de vers√£o
let versionNotificationState = {
    isVisible: true,
    currentStatus: 'updated' // 'updated', 'available', 'downloading', 'ready'
};

// Inicializar sistema de atualiza√ß√µes
function initializeUpdateSystem() {
    console.log('üîÑ Inicializando sistema de atualiza√ß√µes...');
    
    // Carregar informa√ß√µes da aplica√ß√£o
    loadAppInfo();
    
    // Configurar event listeners
    setupUpdateEventListeners();
    
    // Inicializar notifica√ß√£o de vers√£o
    initializeVersionNotification();
    
    // Verificar atualiza√ß√µes automaticamente
    setTimeout(() => {
        checkForUpdates();
    }, 2000);
}

// ==================== NOTIFICA√á√ÉO DE VERS√ÉO ====================

// Inicializar notifica√ß√£o de vers√£o
function initializeVersionNotification() {
    console.log('üîî Inicializando notifica√ß√£o de vers√£o...');
    
    // Configurar event listeners da notifica√ß√£o
    setupVersionNotificationListeners();
    
    // Mostrar status inicial (discreto)
    updateVersionNotification('updated', updateState.currentVersion || '1.0.0');
}

// Configurar event listeners da notifica√ß√£o
function setupVersionNotificationListeners() {
    // Bot√£o de a√ß√£o (download)
    if (versionElements.actionBtn) {
        versionElements.actionBtn.addEventListener('click', () => {
            handleVersionActionClick();
        });
    }
}

// Atualizar notifica√ß√£o de vers√£o
function updateVersionNotification(status, version = null) {
    if (!versionElements.notification) return;
    
    versionNotificationState.currentStatus = status;
    
    // Remover classes de status anteriores
    versionElements.notification.classList.remove('updated', 'update-available', 'update-downloading', 'update-ready');
    
    switch (status) {
        case 'updated':
            versionElements.icon.textContent = '‚úÖ';
            versionElements.text.textContent = `Atualizado v${version}`;
            versionElements.actionBtn.style.display = 'none';
            versionElements.notification.classList.add('updated');
            break;
            
        case 'available':
            versionElements.icon.textContent = 'üîÑ';
            versionElements.text.textContent = 'Atualiza√ß√£o pendente';
            versionElements.actionBtn.style.display = 'flex';
            versionElements.actionBtn.textContent = 'üì•';
            versionElements.actionBtn.title = 'Baixar atualiza√ß√£o';
            versionElements.notification.classList.add('update-available');
            break;
            
        case 'downloading':
            versionElements.icon.textContent = 'üì•';
            versionElements.text.textContent = 'Baixando atualiza√ß√£o...';
            versionElements.actionBtn.style.display = 'none';
            versionElements.notification.classList.add('update-downloading');
            break;
            
        case 'ready':
            versionElements.icon.textContent = 'üöÄ';
            versionElements.text.textContent = 'Atualiza√ß√£o pronta!';
            versionElements.actionBtn.style.display = 'flex';
            versionElements.actionBtn.textContent = 'üîÑ';
            versionElements.actionBtn.title = 'Instalar e reiniciar';
            versionElements.notification.classList.add('update-ready');
            break;
    }
    
    // Mostrar notifica√ß√£o se estava oculta
    showVersionNotification();
    
    console.log(`üîî Notifica√ß√£o atualizada: ${status} v${version}`);
}

// Mostrar notifica√ß√£o de vers√£o
function showVersionNotification() {
    if (versionElements.notification) {
        versionElements.notification.classList.remove('hidden');
        versionNotificationState.isVisible = true;
    }
}

// Ocultar notifica√ß√£o de vers√£o
function hideVersionNotification() {
    if (versionElements.notification) {
        versionElements.notification.classList.add('hidden');
        versionNotificationState.isVisible = false;
    }
}

// Lidar com clique no bot√£o de a√ß√£o
function handleVersionActionClick() {
    switch (versionNotificationState.currentStatus) {
        case 'available':
            // Baixar atualiza√ß√£o
            downloadUpdate();
            break;
        case 'ready':
            // Instalar atualiza√ß√£o
            installUpdate();
            break;
    }
}

// Carregar informa√ß√µes da aplica√ß√£o
async function loadAppInfo() {
    try {
        if (window.electronAPI && window.electronAPI.getUpdateInfo) {
            const info = await window.electronAPI.getUpdateInfo();
            updateState.currentVersion = info.currentVersion;
            
            if (updateElements.currentVersion) {
                updateElements.currentVersion.textContent = info.currentVersion;
            }
            
            // Atualizar notifica√ß√£o de vers√£o com a vers√£o atual
            updateVersionNotification('updated', info.currentVersion);
            
            console.log('üìã Informa√ß√µes da aplica√ß√£o carregadas:', info);
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar informa√ß√µes da aplica√ß√£o:', error);
    }
}

// Configurar event listeners para atualiza√ß√µes
function setupUpdateEventListeners() {
    // Bot√£o de verificar atualiza√ß√µes
    if (updateElements.checkUpdatesBtn) {
        updateElements.checkUpdatesBtn.addEventListener('click', () => {
            checkForUpdates();
        });
    }
    
    // Bot√£o de baixar atualiza√ß√£o
    if (updateElements.downloadUpdateBtn) {
        updateElements.downloadUpdateBtn.addEventListener('click', () => {
            downloadUpdate();
        });
    }
    
    // Bot√£o de instalar atualiza√ß√£o
    if (updateElements.installUpdateBtn) {
        updateElements.installUpdateBtn.addEventListener('click', () => {
            installUpdate();
        });
    }
    
    // Event listeners do auto-updater
    if (window.electronAPI) {
        // Verificando atualiza√ß√µes
        window.electronAPI.onUpdateChecking(() => {
            updateStatus('Verificando atualiza√ß√µes...', 'info');
            updateState.isChecking = true;
            updateUI();
        });
        
        // Atualiza√ß√£o dispon√≠vel
        window.electronAPI.onUpdateAvailable((event, info) => {
            console.log('üì¶ Atualiza√ß√£o dispon√≠vel:', info);
            updateState.updateAvailable = true;
            updateState.latestVersion = info.version;
            updateStatus(`Atualiza√ß√£o dispon√≠vel: v${info.version}`, 'success');
            showDownloadButton();
            
            // Atualizar notifica√ß√£o de vers√£o
            updateVersionNotification('available', info.version);
        });
        
        // Nenhuma atualiza√ß√£o dispon√≠vel
        window.electronAPI.onUpdateNotAvailable((event, info) => {
            console.log('‚úÖ Aplica√ß√£o est√° atualizada:', info);
            updateState.updateAvailable = false;
            updateStatus('Aplica√ß√£o est√° atualizada', 'success');
            hideUpdateButtons();
            
            // Atualizar notifica√ß√£o de vers√£o
            updateVersionNotification('updated', info.version || updateState.currentVersion);
        });
        
        // Erro na verifica√ß√£o
        window.electronAPI.onUpdateError((event, error) => {
            console.error('‚ùå Erro ao verificar atualiza√ß√µes:', error);
            updateStatus(`Erro: ${error}`, 'error');
            updateState.isChecking = false;
            updateUI();
        });
        
        // Progresso do download
        window.electronAPI.onUpdateDownloadProgress((event, progress) => {
            console.log('üì• Progresso do download:', progress);
            updateDownloadProgress(progress);
            
            // Atualizar notifica√ß√£o de vers√£o
            updateVersionNotification('downloading');
        });
        
        // Download conclu√≠do
        window.electronAPI.onUpdateDownloaded((event, info) => {
            console.log('‚úÖ Atualiza√ß√£o baixada:', info);
            updateState.updateDownloaded = true;
            updateState.isDownloading = false;
            updateStatus('Atualiza√ß√£o baixada com sucesso!', 'success');
            showInstallButton();
            hideProgressBar();
            
            // Atualizar notifica√ß√£o de vers√£o
            updateVersionNotification('ready', info.version);
        });
    }
}

// Verificar atualiza√ß√µes
async function checkForUpdates() {
    if (updateState.isChecking || updateState.isDownloading) {
        return;
    }
    
    try {
        console.log('üîç Verificando atualiza√ß√µes...');
        updateState.isChecking = true;
        updateStatus('Verificando atualiza√ß√µes...', 'info');
        updateUI();
        
        if (window.electronAPI && window.electronAPI.checkForUpdates) {
            const result = await window.electronAPI.checkForUpdates();
            console.log('üìã Resultado da verifica√ß√£o:', result);
        }
    } catch (error) {
        console.error('‚ùå Erro ao verificar atualiza√ß√µes:', error);
        updateStatus(`Erro: ${error.message}`, 'error');
        updateState.isChecking = false;
        updateUI();
    }
}

// Baixar atualiza√ß√£o
async function downloadUpdate() {
    if (updateState.isDownloading || !updateState.updateAvailable) {
        return;
    }
    
    try {
        console.log('üì• Baixando atualiza√ß√£o...');
        updateState.isDownloading = true;
        updateStatus('Baixando atualiza√ß√£o...', 'info');
        showProgressBar();
        updateUI();
        
        if (window.electronAPI && window.electronAPI.downloadUpdate) {
            const result = await window.electronAPI.downloadUpdate();
            console.log('üìã Resultado do download:', result);
        }
    } catch (error) {
        console.error('‚ùå Erro ao baixar atualiza√ß√£o:', error);
        updateStatus(`Erro: ${error.message}`, 'error');
        updateState.isDownloading = false;
        updateUI();
    }
}

// Instalar atualiza√ß√£o
async function installUpdate() {
    if (!updateState.updateDownloaded) {
        return;
    }
    
    try {
        console.log('üîÑ Instalando atualiza√ß√£o...');
        updateStatus('Instalando atualiza√ß√£o e reiniciando...', 'info');
        
        if (window.electronAPI && window.electronAPI.installUpdate) {
            const result = await window.electronAPI.installUpdate();
            console.log('üìã Resultado da instala√ß√£o:', result);
        }
    } catch (error) {
        console.error('‚ùå Erro ao instalar atualiza√ß√£o:', error);
        updateStatus(`Erro: ${error.message}`, 'error');
    }
}

// Atualizar status
function updateStatus(message, type = 'info') {
    if (updateElements.updateStatus) {
        updateElements.updateStatus.textContent = message;
    }
    
    if (updateElements.updateMessage) {
        updateElements.updateMessage.textContent = message;
        updateElements.updateMessage.className = `update-message ${type}`;
    }
    
    console.log(`üìä Status: ${message}`);
}

// Atualizar progresso do download
function updateDownloadProgress(progress) {
    const percent = Math.round(progress.percent);
    
    if (updateElements.updateProgressFill) {
        updateElements.updateProgressFill.style.width = `${percent}%`;
    }
    
    if (updateElements.updateProgressText) {
        updateElements.updateProgressText.textContent = `${percent}%`;
    }
    
    // Atualizar status com informa√ß√µes do download
    const speed = formatBytes(progress.bytesPerSecond);
    const downloaded = formatBytes(progress.transferred);
    const total = formatBytes(progress.total);
    
    updateStatus(`Baixando: ${downloaded} / ${total} (${speed}/s)`, 'info');
}

// Mostrar bot√£o de download
function showDownloadButton() {
    if (updateElements.downloadUpdateBtn) {
        updateElements.downloadUpdateBtn.style.display = 'inline-block';
    }
    if (updateElements.checkUpdatesBtn) {
        updateElements.checkUpdatesBtn.style.display = 'none';
    }
}

// Mostrar bot√£o de instala√ß√£o
function showInstallButton() {
    if (updateElements.installUpdateBtn) {
        updateElements.installUpdateBtn.style.display = 'inline-block';
    }
    if (updateElements.downloadUpdateBtn) {
        updateElements.downloadUpdateBtn.style.display = 'none';
    }
}

// Ocultar bot√µes de atualiza√ß√£o
function hideUpdateButtons() {
    if (updateElements.downloadUpdateBtn) {
        updateElements.downloadUpdateBtn.style.display = 'none';
    }
    if (updateElements.installUpdateBtn) {
        updateElements.installUpdateBtn.style.display = 'none';
    }
    if (updateElements.checkUpdatesBtn) {
        updateElements.checkUpdatesBtn.style.display = 'inline-block';
    }
}

// Mostrar barra de progresso
function showProgressBar() {
    if (updateElements.updateProgress) {
        updateElements.updateProgress.style.display = 'block';
    }
}

// Ocultar barra de progresso
function hideProgressBar() {
    if (updateElements.updateProgress) {
        updateElements.updateProgress.style.display = 'none';
    }
}

// Atualizar UI
function updateUI() {
    // Atualizar estado dos bot√µes
    if (updateElements.checkUpdatesBtn) {
        updateElements.checkUpdatesBtn.disabled = updateState.isChecking || updateState.isDownloading;
    }
    if (updateElements.downloadUpdateBtn) {
        updateElements.downloadUpdateBtn.disabled = updateState.isDownloading || !updateState.updateAvailable;
    }
    if (updateElements.installUpdateBtn) {
        updateElements.installUpdateBtn.disabled = !updateState.updateDownloaded;
    }
}

// Formatar bytes para leitura humana
function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
    
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}

// Inicializar sistema de atualiza√ß√µes quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    // Aguardar um pouco para garantir que tudo esteja carregado
    setTimeout(() => {
        initializeUpdateSystem();
    }, 1000);
});

console.log('üì± Frontend carregado com sucesso!');
